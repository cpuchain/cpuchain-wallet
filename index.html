<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CPUchain Wallet</title>
		<meta name="description" content="CPUchain Web Wallet">

		<link id="coin-favicon" rel="icon" type="image/png" href="./logos/cpuchain.png">

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@jsweb/font-awesome-base64@2.4.2/fa-all.css" integrity="sha384-rAubePlPr5GmhldeD91zL0pl+HTbUXQ68qd7Dw9hoghRR4PBSVDG5ms/fhlYX1vW" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs4@2.3.0/css/dataTables.bootstrap4.min.css" integrity="sha384-pS7W8+ms7KVt9n2PuoDEGqtv4WZGbgpK0dyMGVU2q8WfoyfybLKfgWO2t/NSLZLF" crossorigin="anonymous">

		<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3/jquery.qrcode.min.js" integrity="sha384-0B/45e2to395pfnCkbfqwKFFwAa7zXdvd42eAFJa3Vm8KZ/jmHdn93XdWi//7MDS" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/datatables.net@2.3.0/js/dataTables.min.js" integrity="sha384-ehaRe3xJ0fffAlDr3p72vNw3wWV01C1/Z19X6s//i6hiF8hee+c+rabqObq8YlOk" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs4@2.3.0/js/dataTables.bootstrap4.min.js" integrity="sha384-lzE84zE76t/xTDUpoKl8o6c0h10nNP8YllhiEMM0c/sSn4F16OzlMehMoHkVTsTN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/ethers@6.14.1/dist/ethers.umd.min.js" integrity="sha384-LCTN2+xbDN7LFaPDNPRAfolq7k2r8NDMfUTaBW8DZgY/vnp79iUNo6C4uYzYXxiO" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" integrity="sha384-b5Ya4Bq3qCyz39m2ISh+4DxjAIljdeFwK/BsXLuj9gugaNwAcj/ia15fxNZL9Nlx" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.js" integrity="sha384-lLGuFiulNF2N/nqC6IxFZzy3WGfLokEKQD73HN9gCx1vFouvtty5kp+wf20Rrs0Y" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bignumber.js@9.3.0/bignumber.js" integrity="sha384-BSg6irOn0GCWvI6HSttJyRMZl4tEZoz5N6JG1REqgtYJSCtxcqDx6Y0MGlHZeGbo" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/btc-signer@1.1.0/lib/bitcoin.umd.min.js" integrity="sha384-Mz2ePSJXKLEKK3FitWWmIOGhFwWyMxhWbKHXKNSiN+gR1Tb0hBNQ03NU3Ece3037" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/btc-signer@1.1.0/lib/btcSigner.umd.js" integrity="sha384-hjaYFmpkDSbVspLqUQlLtAsf3awzyXSOIoEYxf+9QbIKZ+0v1JI9YxSP3Ev11P0d" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/ethers-ext@1.0.7/lib/ethExt.umd.js" integrity="sha384-/IVwsfBbk4Y0kpSgjazrAGMiWrNOkh3+WAgwZV0+G25Xca9wib51hlgKJ3YCHZ4C" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/coingecko-tokens@1.0.3/lib/geckoTokens.umd.min.js" integrity="sha384-WXHoIJ8B+M/n4tfiqOdb+UiBvd4M94EfwSCQ6gCgPVOZ2e0thglS3qi14aXQPHZe" crossorigin="anonymous"></script>
		<script src="./multilang.js"></script>
		<script src="./logos.js"></script>

		<style>
			html {
				height: 100%;
			}
			html, body {
				min-height: 100%;
			}
			body {
				font-family: Arial, Helvetica, sans-serif;
				padding-top: 75px;
				padding-bottom: 56px;
				position: relative;
			}
			#logo {
				max-width: 30px;
				max-height: 30px;
				margin-top: -5px;
				margin-right: 5px;
			}
			.b-width {
				min-width: 100px;
			}
			.navbar-dark .navbar-nav .nav-link.active {
				color: rgba(255,255,255,.75);
			}
			.router-page {
				display: none;
			}
			.c-pointer {
				cursor: pointer;
			}
			.disabled {
				pointer-events: none;
			}
			.break-lines {
			  /* https://stackoverflow.com/a/18706058/9217774 <3 */
			  -ms-word-break: break-all;
				word-break: break-all;

			  /* Non standard for webkit */
				word-break: break-word;

				-webkit-hyphens: auto;
				   -moz-hyphens: auto;
					-ms-hyphens: auto;
						hyphens: auto;
			}
			.qr-code canvas{
				max-width: 100%;
			}
			.f-15 {
				font-size: 15px;
			}
			.f-18 {
				font-size: 18px;
			}
			.f-20 {
				font-size: 20px;
			}
			.f-23 {
				font-size: 23px;
			}
			.w-35 {
				width: 35%;
			}
			.card-header-tabs .nav-item {
				margin-right: 0.5rem;
			}
			@media (max-width: 991.98px) {
				.navbar-expand-lg>.container, .navbar-expand-lg>.container-fluid {
					padding-right: 15px;
					padding-left: 15px;
				}
				.mobile-hide {
					display: none;
				}
				.card-header-tabs .nav-item {
					margin-right: 0rem;
				}
			}
			.send-balance-fix {
				padding: 0px 0px 8px 0px;
				display: inline-block;
			}
			.break-word {
				word-wrap: break-word;
			}
		</style>
	</head>
	<body>
		<!-- Navbar -->
		<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
			<div class="container">
				<a href="#" class="navbar-brand">
					<img id="coin-logo" src="./logos/cpuchain.png" style="height: 30px; margin-right: 5px;">
					<span id="coin-title">CPUchain Wallet</span>
				</a>
				<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarResponsive">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item">
							<a href="#" class="nav-link router-link mr-md-2" data-route="homepage" tkey="home"></a>
						</li>
						<li class="nav-item">
							<a href="#/create" class="nav-link router-link mr-md-2" data-route="create" tkey="create"></a>
						</li>
						<li class="nav-item">
							<a href="#/broadcast" class="nav-link router-link mr-md-2" data-route="broadcast" tkey="broadcast"></a>
						</li>
						<li class="nav-item">
							<a href="#/settings" class="nav-link router-link mr-md-2" data-route="settings" tkey="settings"></a>
						</li>
						<li class="nav-item dropdown">
							<a id="network-versions" class="nav-item nav-link dropdown-toggle" href="#" data-toggle="dropdown">NETWORK</a>
							<div id="network-list" class="dropdown-menu dropdown-menu-right" aria-labelledby="network-versions" ></div>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Context starts here -->
		<div class="container">

			<!-- Error message and search -->
			<div id="error-message" class="alert alert-warning d-none" role="alert">
				Error, yay ∠( ᐛ 」∠)
			</div>
	
			<!-- Home page -->
			<div id="homepage" class="router-page">
				<!-- Open Wallet Card -->
				<div class="before-open">
					<div class="card mb-3">
						<div class="card-header">
							<ul class="nav nav-tabs card-header-tabs open-card-tabs">
								<li class="nav-item">
									<a class="nav-link tab-link active" data-tab-name="open-email-legacy" data-tab-family="open-card" href="#" tkey="open-email-legacy"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="open-bip39" data-tab-family="open-card" href="#" tkey="open-email-bip39"></a>
								</li>
								<li class="nav-item eth-only">
									<a class="nav-link tab-link" data-tab-name="open-browser" data-tab-family="open-card" href="#" tkey="open-browser"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="open-view" data-tab-family="open-card" href="#" tkey="open-view"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="open-mnemonic" data-tab-family="open-card" href="#" tkey="open-mnemonic"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="open-key" data-tab-family="open-card" href="#" tkey="open-key"></a>
								</li>
							</ul>
						</div>

						<div class="card-body">
							<form action="javascript:;" onsubmit="openWallet('email')" class="open-email-legacy open-card mt-2">
								<div class="input-group pb-2">
									<input id="open-email" class="form-control" type="text" tkey="email-address">
								</div>
								<div class="input-group pb-2">
									<input id="open-password" class="form-control" type="password" tkey="password">
									<input id="open-password-confirm" class="form-control" type="password" tkey="password-confirm">
									<div class="input-group-append">
										<select class="custom-select address-type-select form-control btc-only">
										</select>
									</div>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>

							<form action="javascript:;" onsubmit="openWallet('bip39')" class="open-bip39 open-card mt-2 d-none">
								<div class="input-group pb-2">
									<input id="bip39-email" class="form-control" type="text" tkey="email-address">
								</div>
								<div class="input-group pb-2">
									<input id="bip39-password" class="form-control" type="password" tkey="password">
									<input id="bip39-password-confirm" class="form-control" type="password" tkey="password-confirm">
									<div class="input-group-append">
										<select class="custom-select address-type-select form-control btc-only">
										</select>
									</div>
								</div>
								<div class="input-group pb-2">
									<input id="bip39-third-params" class="form-control" type="text" tkey="bip39-third-params">
									<input id="bip39-nonce" class="form-control" type="number" tkey="bip39-nonce">
								</div>
								<div class="input-group pb-2">
									<input id="bip39-mnemonic-index" class="form-control" type="number" tkey="bip39-mnemonic-index">
									<select id="bip39-mnemonic-length" class="form-control">
										<option value selected>24 words (Default)</option>
										<option value="12">12 Words</option>
										<option value="15">15 Words</option>
										<option value="18">18 Words</option>
										<option value="21">21 Words</option>
										<option value="24">24 Words</option>
									</select>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>

							<form action="javascript:;" onsubmit="openWallet('browser')" class="open-browser open-card mt-2 d-none">
								<div class="input-group pb-2">
									<select id="wallet-select" class="custom-select form-control">
										<option value="metamask" selected>Metamask</option>
										<option value="trust">Trust Wallet</option>
									</select>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>

							<form action="javascript:;" onsubmit="openWallet('viewOnly')" class="open-view open-card mt-2 d-none">
								<div class="input-group pb-2">
									<input id="view-only-address" class="form-control" type="text" tkey="view-key">
									<div class="input-group-append">
										<select class="custom-select address-type-select form-control btc-only">
										</select>
									</div>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>

							<form action="javascript:;" onsubmit="openWallet('mnemonic')" class="open-mnemonic open-card mt-2 d-none">
								<div class="input-group pb-2">
									<input id="mnemonic" class="form-control" type="text" tkey="mnemonic-key">
								</div>
								<div class="input-group pb-2">
									<input id="mnemonic-index" class="form-control" type="number" value="0" tkey="mnemonic-index">
									<div class="input-group-append">
										<select class="custom-select address-type-select form-control btc-only">
										</select>
									</div>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>

							<form action="javascript:;" onsubmit="openWallet('privateKey')" class="open-key open-card mt-2 d-none">
								<div class="input-group pb-2">
									<input id="private-key" class="form-control" type="password" tkey="wif-key">
									<div class="input-group-append">
										<select class="custom-select address-type-select form-control btc-only">
										</select>
									</div>
								</div>
								<button class="btn btn-primary btn-block" type="submit" tkey="open"></button>
							</form>
						</div>

						<div class="card-footer">
							<div class="open-email-legacy open-card">
								<span tkey="open-reminder"></span>
							</div>
							<div class="open-bip39 open-card d-none">
								<span tkey="open-reminder"></span>
							</div>
							<div class="open-browser open-card d-none">
								<span tkey="generate-question"></span> <span tkey="install-wallet"></span>
							</div>
							<div class="open-view open-card d-none">
								<span tkey="generate-question"></span> <span tkey="generate-it"></span>
							</div>
							<div class="open-mnemonic open-card d-none">
								<span tkey="generate-mnemonic"></span>
							</div>
							<div class="open-key open-card d-none">
								<span tkey="generate-question"></span> <span tkey="generate-it"></span>
							</div>
						</div>
					</div>
				</div>

				<!-- Wallet Card -->
				<div class="on-open d-none">
					<div class="card mb-3">
						<div class="card-header">
							<ul class="nav nav-tabs card-header-tabs wallet-card-tabs">
								<li class="nav-item">
									<a class="nav-link tab-link active" data-tab-name="wallet-main" data-tab-family="wallet-card" href="#" tkey="wallet"></a>
								</li>
								<li class="nav-item eth-only">
									<a class="nav-link tab-link" data-tab-name="wallet-tokens" data-tab-family="wallet-card" href="#" tkey="tokens"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="wallet-send" data-tab-family="wallet-card" href="#" tkey="send"></a>
								</li>
								<li class="nav-item eth-only">
									<a class="nav-link tab-link" data-tab-name="token-send" data-tab-family="wallet-card" href="#" tkey="send-token"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="wallet-sign" data-tab-family="wallet-card" href="#" tkey="sign"></a>
								</li>
								<li class="nav-item">
									<a id="history-link" class="nav-link" target="_blank" rel="noreferrer nofollow" href="#" tkey="history"></a>
								</li>
								<li class="nav-item">
									<a class="nav-link tab-link" data-tab-name="wallet-keys" data-tab-family="wallet-card" href="#" tkey="keys"></a>
								</li>
							</ul>
						</div>
						<div class="card-body">
							<div class="wallet-main wallet-card mt-2 text-center">
								<div id="qr-code-addres" class="qr-code"></div>
								<div id="wallet-address"></div>
								<div class="mb-0 pb-0 c-pointer f-23 update-balance">
									<span class="wallet-amount f-20 text-monospace"></span>
									<span class="wallet-ticker" tkey="loading"></span>
								</div>
								<div class="mb-0 pb-0 c-pointer f-18 btc-only">
									<span> ( Coinbase: </span>
									<span class="coinbase-amount"></span>
									<span class="wallet-ticker" tkey="loading"></span>
									<span> )</span>
								</div>
							</div>

							<div class="wallet-tokens wallet-card d-none">
								<table id="tokens-table" class="table table-bordered">
									<thead>
										<tr>
											<th>Token</th>
											<th>Contract Address</th>
											<th>Balance</th>
										</tr>
									</thead>
								</table>
							</div>

							<form action="javascript:;" onsubmit="populateTransaction()" class="wallet-send wallet-card d-none">
								<div class="mb-2">
									<span tkey="available-balance"></span>
									<b class="f-15 c-pointer fill-balance">
										<span class="wallet-amount"></span>
										<span class="wallet-ticker" tkey="loading"></span>
									</b>
									<b class="f-15 c-pointer btc-only">
										<span> ( Coinbase: </span>
										<span class="coinbase-amount"></span>
										<span class="wallet-ticker" tkey="loading"></span>
										<span> )</span>
									</b>

									<span>
										(
										<span tkey="current-fees"></span>
										<b class="f-15 c-pointer">
											<span class="fee-rate"></span>
										</b>
										)
									</span>

									<div class="float-md-right">
										<a onclick="showScanModal()" href="#" class="text-dark pr-1">
											<span tkey="scan-qr"></span>
											<span class="fa-solid fa-camera"></span>
										</a>
										<a onclick="resetTxForm()" href="#" class="text-dark">
											<span tkey="reset"></span>
											<span class="fa-solid fa-rotate-right"></span>
										</a>
										<a onclick="populateConsolidation()" href="#" class="text-dark btc-only">
											<span tkey="consolidate"></span>
											<span class="fa-solid fa-cart-plus"></span>
										</a>
									</div>
								</div>
								
								<div id="send-outputs">
									<div class="input-group send-outputs-item mb-2">
										<input name="send-address" class="form-control" type="text" value="" tkey="enter-address">
										<input name="send-amount" class="form-control" type="text" value="" tkey="amount">
										<div class="input-group-append btc-only">
											<button id="add-output" class="btn btn-outline-dark" type="button">
												<span class="fa-solid fa-circle-plus"></span>
											</button>
										</div>
									</div>
								</div>

								<div class="input-group">
									<input id="optional-data" class="form-control" type="text" value="" tkey="optional-data">
									<div class="input-group-append">
										<button class="btn btn-primary b-width" type="submit" tkey="send"></button>
									</div>
								</div>
							</form>

							<form action="javascript:;" onsubmit="populateToken()" class="token-send wallet-card d-none">
								<div class="input-group mb-2">
									<input id="send-token-contract" class="form-control" type="text" value="" tkey="enter-token-address">
								</div>

								<div class="input-group mb-2">
									<input id="send-token-address" class="form-control" type="text" value="" tkey="enter-address">
									<input id="send-token-amount" class="form-control" type="text" value="" tkey="token-amount">
									<div class="input-group-append">
										<button onclick="getMaxToken()" type="button" class="btn btn-outline-dark b-width">MAX</button>
									</div>
								</div>

								<div class="input-group">
									<button class="btn btn-primary btn-block" type="submit" tkey="send"></button>
								</div>
							</form>

							<form action="javascript:;" onsubmit="parseTransaction()" class="wallet-sign wallet-card d-none">
								<textarea id="wallet-sign-input" class="form-control pb-2 mb-2" rows="6" tkey="enter-serialized"></textarea>
								<button type="submit" class="btn btn-primary btn-block pb-2" tkey="send"></button>
							</form>
							
							<div class="wallet-keys wallet-card d-none">
								<label tkey="mnemonic"></label>
								<div class="input-group pb-2">
									<input id="wallet-keys-mnemonic" class="form-control" readonly type="text">
								</div>

								<label tkey="address"></label>
								<div class="input-group pb-2">
									<input id="wallet-keys-address" class="form-control" readonly type="text">
								</div>

								<label tkey="public-key"></label>
								<div class="input-group pb-2">
									<input id="wallet-keys-pubkey" class="form-control" readonly type="text">
								</div>

								<label tkey="private-key"></label>
								<div class="input-group pb-2">
									<input id="wallet-keys-privkey" class="form-control keys-privkey" readonly data-original-title="" title="" type="password">
									<span class="input-group-append">
										<button class="btn btn-outline-dark b-width toggle-priv-key" type="button" tkey="show"></button>
									</span>
								</div>

								<div class="btc-only">
									<label tkey="redeem-script"></label>
									<div class="input-group pb-2">
										<input id="wallet-keys-script" class="form-control" readonly type="text">
									</div>
								</div>
							</div>
						</div>
						<div class="card-footer">
							<button onclick="closeWallet()" type="button" class="btn btn-danger btn-block footer-item" tkey="close"></button>
						</div>
					</div>
				</div>
			</div>

			<!-- Generate address -->
			<div id="create" class="router-page">
				<div class="card mb-3">
					<div class="card-header">
						<b tkey="create-wallet"></b>
					</div>
					<div class="card-body">
						<label tkey="mnemonic"></label>
						<div class="input-group pb-2">
							<input id="create-keys-mnemonic" class="form-control" readonly type="text">
						</div>

						<label tkey="address"></label>
						<div class="input-group pb-2">
							<input id="create-keys-address" class="form-control" readonly type="text">
						</div>

						<label tkey="public-key"></label>
						<div class="input-group pb-2">
							<input id="create-keys-pubkey" class="form-control" readonly type="text">
						</div>

						<label tkey="private-key"></label>
						<div class="input-group pb-2">
							<input id="create-keys-privkey" class="form-control keys-privkey" readonly data-original-title="" title="" type="text">
							<span class="input-group-append">
								<button class="btn btn-outline-dark b-width toggle-priv-key" type="button" tkey="hide"></button>
							</span>
						</div>
					</div>
					<div class="card-footer">
						<button onclick="createWallet()" type="button" class="btn btn-primary btn-block footer-item" tkey="create"></button>
					</div>
				</div>
			</div>

			<!-- Broadcast transaction -->
			<div id="broadcast" class="router-page">
				<div class="card mb-3">
					<div class="card-header">
						<b tkey="broadcast-transaction"></b>
					</div>
					<div class="card-body">
						<textarea id="transaction-broadcast-raw" class="form-control" rows="4" tkey="enter-transaction"></textarea>
					</div>
					<div class="card-footer">
						<button onclick="broadcastTransaction()" type="button" class="btn btn-primary btn-block footer-item" tkey="broadcast"></button>
					</div>
				</div>
			</div>

			<!-- Settings transaction -->
			<div id="settings" class="router-page">
				<div class="card mb-3">
					<div class="card-header">
						<b tkey="wallet-settings"></b>
					</div>
					<div class="card-body">
						<form action="javascript:;" onsubmit="saveSettings()">

							<label tkey="wallet-backend"></label>
							<div class="input-group pb-2">
								<select id="wallet-backend-selected" class="custom-select"></select>
							</div>

							<div class="custom-backend d-none">
								<label tkey="wallet-custom-backend"></label>
									<div class="input-group pb-2">
									<input id="wallet-custom-backend" class="form-control" type="text" tkey="wallet-api">
								</div>
							</div>

							<label tkey="wallet-language"></label>
							<div class="input-group pb-2">
								<select id="wallet-language-select" class="custom-select"></select>
							</div>

							<label tkey="wallet-fee-multiplier"></label>
							<div class="input-group pb-2">
								<select id="wallet-fee-select" class="custom-select"></select>
							</div>

							<div class="eth-only">
								<label tkey="wallet-fee-priority"></label>
								<div class="input-group pb-3">
									<select id="wallet-fee-priority" class="custom-select"></select>
								</div>
							</div>

							<button class="btn btn-primary btn-block" type="submit" tkey="update"></button>

						</form>

					</div>
					<div class="card-footer">
						<span tkey="version"></span> <b id="wallet-version"></b>
					</div>
				</div>
			</div>

			<div class="disclaimer mb-3">
				<div class="text-center">
					<small class="text-muted" style="max-width: 1100px;" tkey="disclaimer"></small>
				</div>
			</div>

			<!-- Footer :3 -->
			<footer class="mb-3">
				<div class="text-center">
					Made with <span class="fa-solid fa-heart text-danger"></span> by <a href="https://github.com/cpuchain/cpuchain-wallet" target="_blank" rel="noreferrer nofollow">CPUchain Community</a>
				</div>
			</footer>
		
		</div>

		<div id="send-modal" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 id="send-title" class="modal-title"></h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="confirm-screen" class="d-none">
							<div id="confirm-table" class="mobile-hide"></div>
							<div id="confirm-context"></div>
						</div>
						<div id="status-screen" class="d-none">
							<div id="status-context" class="mt-1"></div>
						</div>
					</div>
					<div class="modal-footer d-flex">
						<button data-dismiss="modal"                            type="button" class="btn btn-dark flex-fill"                     tkey="cancel"></button>
						<button id="send-create"  onclick="createTransaction()" type="button" class="btn btn-outline-dark flex-fill mobile-hide" tkey="create-it"></button>
						<button id="send-sign"    onclick="signTransaction()"   type="button" class="btn btn-outline-dark flex-fill mobile-hide" tkey="sign-it"></button>
						<button id="send-confirm" onclick=""                    type="button" class="btn btn-primary flex-fill"                  tkey="send-it"></button>
					</div>
				</div>
			</div>
		</div>

		<div id="scan-modal" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-md" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" tkey="scan-modal-title"></h5>
						<button id="scan-close" type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="loading-message">
							
						</div>
						<canvas id="scan-canvas" hidden class="w-100"></canvas>
					</div>
				</div>
			</div>
		</div>

		<!-- All magic is here :D -->
		<script>
			/*global $, bitcoin, btcSigner, ethers, ethExt, walletLanguages, embedded, tokenlist, jsQR*/
			// todo: replace bitcoinjs with @scure/btc-signer which provides similar interface with bitcoinjs but supports bigint
			// so that we could sign transactions with large amount of coins like Dogecoin
			if (!BigInt.prototype?.toJSON) {
				BigInt.prototype.toJSON = function () {
					return this.toString();
				};
			}

			const WALLET_VERSION = '1.13';

			const DEFAULT_NETWORK = 'CPU';

			const DEFAULT_LANGUAGE = 'en';

			const TOKEN_LIST = 'https://cdn.jsdelivr.net/gh/cpuchain/coingecko-tokens@main/tokenlist.top.json';

			const MEMPOOL_INSTANCES = ['mempool', 'litecoinspace'];

			// Config
			let tokenlist;

			let localDB = new ethExt.IndexedDB({ name: 'CPUchain Wallet', version: Number(WALLET_VERSION) });

			let stream = undefined;

			const settings = {
				network: null,
				node: null,
				language: null,
				feeMultiplier: null,
				feePriority: null,
			};

			const globalData = {
				cachedBalance: null,
				balance: 0,
				provider: null,
				signer: null,
				tx: null,
				walletTimeout: null,
				walletSyncing: false,
				walletInterval: null,
				tokenTable: null,
				resetTx: function() {
					this.tx = null;
				},
				clear: function() {
					this.cachedBalance = null;
					this.balance = 0;
					this.provider = null;
					this.signer = null;
					this.tx = null;
					this.walletSyncing = false;
					if (this.walletInterval) {
						clearInterval(this.walletInterval);
						this.walletSyncing = false;
						this.walletInterval = null;
					}
					if (this.tokenTable) {
						this.tokenTable.clear().draw();
					}
				},
			};

			const networkConfigs = {
				CPU: {
					uri: 'cpuchain:',
					title: 'CPUchain Wallet',
					name: 'CPUchain (CPU)',
					logo: 'cpuchain.png',
					nodes: [
						'https://blockbook.cpuchain.org',
					],
					ticker: 'CPU',
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://explorer.cpuchain.org/#',
					network: {
						messagePrefix: '\x19CPUchain Signed Message:\n',
						bip32: {
							public: 0x0488b21e,
							private: 0x0488ade4,
						},
						bech32: 'cpu',
						pubKeyHash: 0x1C,
						scriptHash: 0x1E,
						wif: 0x80,
						versions: {
							bip44: 363,
						},
					},
				},
				BTC: {
					uri: 'bitcoin:',
					title: 'Bitcoin Wallet',
					name: 'Bitcoin (BTC)',
					logo: 'bitcoin.png',
					nodes: [
						'https://mempool.space',
						'https://mempool.emzy.de',
					],
					ticker: 'BTC',
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://mempool.space',
					network: {
						...bitcoin.networks.bitcoin,
						versions: {
							bip44: 0,
						},
					},
				},
				LTC: {
					uri: 'litecoin:',
					title: 'Litecoin Wallet',
					name: 'Litecoin (LTC)',
					logo: 'litecoin.png',
					nodes: [
						'https://litecoinspace.org',
					],
					ticker: 'LTC',
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://litecoinspace.org',
					network: bitcoin.coininfo('LTC').toBitcoinJS(),
				},
				ETH: {
					uri: 'ethereum:',
					title: 'Ethereum Wallet',
					name: 'Ethereum (ETH)',
					logo: 'ethereum.png',
					chainId: 1,
					nodes: [
						'https://rpc.mevblocker.io',
						'https://1rpc.io/eth',
						'https://eth.nodeconnect.org',
						'https://eth.rpc.blxrbdn.com',
						'https://eth-mainnet.nodereal.io/v1/1659dfb40aa24bbb8153a677b98064d7',
						'https://go.getblock.io/aefd01aa907c4805ba3c00a9e5b48c6b',
						'https://ethereum.blockpi.network/v1/rpc/public',
						'https://rpc.eth.gateway.fm',
						'https://ethereum.rpc.subquery.network/public',
						'https://ethereum.keydonix.com/v1/mainnet',
						'https://0xrpc.io/eth',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://etherscan.io',
					fallbackGas: {
						maxFeePerGas: '50',
						maxPriorityFeePerGas: '0.001',
					},
				},
				ARB: {
					uri: 'ethereum:',
					title: 'Arbitrum Wallet',
					name: 'Arbitrum One (ETH)',
					logo: 'ethereum.png',
					chainId: 42161,
					nodes: [
						'https://arb1.arbitrum.io/rpc',
						'https://1rpc.io/arb',
						'https://arbitrum-one.public.blastapi.io',
						'https://arbitrum-one.publicnode.com',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://arbiscan.io',
					fallbackGas: {
						maxFeePerGas: '0.2',
						maxPriorityFeePerGas: '0',
					},
				},
				OP: {
					uri: 'ethereum:',
					title: 'Optimism Wallet',
					name: 'Optimism (ETH)',
					logo: 'ethereum.png',
					chainId: 10,
					nodes: [
						'https://mainnet.optimism.io',
						'https://optimism-mainnet.public.blastapi.io',
						'https://1rpc.io/op',
						'https://optimism.publicnode.com',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://optimistic.etherscan.io',
					opGasPriceOracle: ethExt.GAS_PRICE_ORACLE_ADDRESS,
					fallbackGas: {
						maxFeePerGas: '0.02',
						maxPriorityFeePerGas: '0.001',
					},
				},
				BASE: {
					uri: 'ethereum:',
					title: 'Base Wallet',
					name: 'Base (ETH)',
					logo: 'ethereum.png',
					chainId: 8453,
					nodes: [
						'https://mainnet.base.org',
						'https://1rpc.io/base',
						'https://base.meowrpc.com',
						'https://base-mainnet.public.blastapi.io',
						'https://base-rpc.publicnode.com',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://basescan.org',
					opGasPriceOracle: ethExt.GAS_PRICE_ORACLE_ADDRESS,
					fallbackGas: {
						maxFeePerGas: '0.02',
						maxPriorityFeePerGas: '0.001',
					},
				},
				UNI: {
					uri: 'ethereum:',
					title: 'Unichain Wallet',
					name: 'Unichain (ETH)',
					logo: 'ethereum.png',
					chainId: 130,
					nodes: [
						'https://mainnet.unichain.org',
						'https://0xrpc.io/uni',
						'https://unichain-rpc.publicnode.com',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://uniscan.xyz',
					opGasPriceOracle: ethExt.GAS_PRICE_ORACLE_ADDRESS,
					fallbackGas: {
						maxFeePerGas: '0.02',
						maxPriorityFeePerGas: '0.001',
					},
				},
				BNB: {
					uri: 'ethereum:',
					title: 'BNB Wallet',
					name: 'BNB Chain (BNB)',
					logo: 'bnb.png',
					chainId: 56,
					nodes: [
						'https://bsc-dataseed.bnbchain.org',
						'https://bsc-dataseed1.defibit.io',
						'https://bsc-dataseed1.ninicoin.io',
						'https://bsc-dataseed1.bnbchain.org',
						'https://binance.nodereal.io',
						'https://bsc-mainnet.nodereal.io/v1/64a9df0874fb4a93b9d0a3849de012d3',
						'https://1rpc.io/bnb',
						'https://bsc-mainnet.public.blastapi.io',
						'https://bsc.rpc.blxrbdn.com',
						'https://bsc-rpc.publicnode.com',
						'https://rpc-bsc.48.club',
						'https://go.getblock.io/cc778cdbdf5c4b028ec9456e0e6c0cf3',
						'https://bsc.rpc.blxrbdn.com',
						'https://bsc.blockrazor.xyz',
					],
					ticker: 'BNB',
					decimals: 18,
					explorer: 'https://bscscan.com',
					fallbackGas: {
						gasPrice: '0.1',
					},
				},
				POLY: {
					uri: 'ethereum:',
					title: 'Polygon Wallet',
					name: 'Polygon (MATIC)',
					logo: 'polygon.png',
					chainId: 137,
					nodes: [
						'https://polygon-rpc.com',
						'https://1rpc.io/matic',
						'https://polygon.api.onfinality.io/public',
						'https://polygon-bor-rpc.publicnode.com',
						'https://rpc-mainnet.matic.quiknode.pro',
						'https://polygon-mainnet.public.blastapi.io',
					],
					ticker: 'MATIC',
					decimals: 18,
					explorer: 'https://polygonscan.com',
					fallbackGas: {
						maxFeePerGas: '120',
						maxPriorityFeePerGas: '32',
					},
				},
				AVAX: {
					uri: 'ethereum:',
					title: 'Avalanche Wallet',
					name: 'Avalanche (AVAX)',
					logo: 'avalanche.png',
					chainId: 43114,
					nodes: [
						'https://avalanche-c-chain-rpc.publicnode.com',
						'https://api.avax.network/ext/bc/C/rpc',
						'https://1rpc.io/avax/c',
						'https://avalanche.drpc.org',
						'https://ava-mainnet.public.blastapi.io/ext/bc/C/rpc',
					],
					ticker: 'AVAX',
					decimals: 18,
					explorer: 'https://snowtrace.io',
					fallbackGas: {
						maxFeePerGas: '50',
						maxPriorityFeePerGas: '0',
					},
				},
				XDAI: {
					uri: 'ethereum:',
					title: 'Gnosis Wallet',
					name: 'Gnosis Chain (XDAI)',
					logo: 'gnosis.png',
					chainId: 100,
					nodes: [
						'https://rpc.gnosischain.com',
						'https://gnosis-mainnet.public.blastapi.io',
						'https://1rpc.io/gnosis',
						'https://gnosis.api.onfinality.io/public',
						'https://gnosis-rpc.publicnode.com',
						'https://gnosis.oat.farm',
						'https://0xrpc.io/gno',
					],
					ticker: 'XDAI',
					decimals: 18,
					explorer: 'https://gnosisscan.io',
					fallbackGas: {
						maxFeePerGas: '3',
						maxPriorityFeePerGas: '1.5',
					},
				},
				ETC: {
					uri: 'ethereum:',
					title: 'Ethereum Classic Wallet',
					name: 'Ethereum Classic (ETC)',
					logo: 'etc.png',
					chainId: 61,
					nodes: [
						'https://etc.rivet.link',
						'https://etc.etcdesktop.com',
						'https://rpc.etcinscribe.com',
						'https://etc.mytokenpocket.vip',
						'https://0xrpc.io/etc',
					],
					ticker: 'ETC',
					decimals: 18,
					explorer: 'https://etc.blockscout.com',
					fallbackGas: {
						gasPrice: '1.5',
					},
				},
				TCPU: {
					uri: 'cpuchain:',
					title: 'CPUchain Testnet Wallet',
					name: 'CPUchain Testnet (CPU)',
					logo: 'cpuchain.png',
					nodes: [
						'https://testnet-blockbook.cpuchain.org'
					],
					ticker: 'CPU',
					slip44: 363,
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://explorer.cpuchain.org/testnet/#',
					network: {
						messagePrefix: '\x19CPUchain Signed Message:\n',
						bip32: {
							public: 0x043587CF,
							private: 0x04358394,
						},
						bech32: 'tcpu',
						pubKeyHash: 0x6F,
						scriptHash: 0xC4,
						wif: 0xEF,
					},
				},
				TBTC: {
					uri: 'bitcoin:',
					title: 'Bitcoin Testnet3 Wallet',
					name: 'Bitcoin Testnet3 (BTC)',
					logo: 'bitcoin.png',
					nodes: [
						'https://mempool.space/testnet',
						'https://mempool.emzy.de/testnet',
					],
					ticker: 'BTC',
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://mempool.space/testnet',
					network: {
						...bitcoin.networks.testnet,
						versions: {
							bip44: 1,
						},
					},
				},
				TBTC4: {
					uri: 'bitcoin:',
					title: 'Bitcoin Testnet4 Wallet',
					name: 'Bitcoin Testnet4 (BTC)',
					logo: 'bitcoin.png',
					nodes: [
						'https://mempool.space/testnet4',
						'https://mempool.emzy.de/testnet4',
					],
					ticker: 'BTC',
					decimals: 8,
					fee: 0.00001,
					explorer: 'https://mempool.space/testnet4',
					network: {
						...bitcoin.networks.testnet,
						versions: {
							bip44: 1,
						},
					},
				},
				SEP: {
					uri: 'ethereum:',
					title: 'Sepolia Testnet Wallet',
					name: 'Sepolia Testnet (ETH)',
					logo: 'ethereum.png',
					chainId: 11155111,
					nodes: [
						'https://ethereum-sepolia.publicnode.com',
						'https://eth-sepolia.public.blastapi.io',
						'https://1rpc.io/sepolia',
						'https://rpc.sepolia.ethpandaops.io',
						'https://rpc-sepolia.rockx.com',
						'https://eth-sepolia.api.onfinality.io/public',
						'https://ethereum-sepolia.rpc.subquery.network/public',
						'https://0xrpc.io/sep',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://sepolia.etherscan.io',
					fallbackGas: {
						maxFeePerGas: '1',
						maxPriorityFeePerGas: '0.001',
					},
				},
				BASE_SEP: {
					uri: 'ethereum:',
					title: 'Base Sepolia Wallet',
					name: 'Base Sepolia (ETH)',
					logo: 'ethereum.png',
					chainId: 84532,
					nodes: [
						'https://sepolia.base.org',
						'https://base-sepolia-rpc.publicnode.com',
						'https://base-sepolia.blockpi.network/v1/rpc/public',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://sepolia.basescan.org',
					opGasPriceOracle: ethExt.GAS_PRICE_ORACLE_ADDRESS,
					fallbackGas: {
						maxFeePerGas: '1',
						maxPriorityFeePerGas: '0.001',
					},
				},
				HOODI: {
					uri: 'ethereum:',
					title: 'Hoodi Testnet Wallet',
					name: 'Hoodi Testnet (ETH)',
					logo: 'ethereum.png',
					chainId: 560048,
					nodes: [
						'https://ethereum-hoodi-rpc.publicnode.com',
						'https://rpc.hoodi.ethpandaops.io',
						'https://0xrpc.io/hoodi',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://hoodi.etherscan.io',
					fallbackGas: {
						maxFeePerGas: '1',
						maxPriorityFeePerGas: '0.001',
					},
				},
				CUSTOM: {
					uri: 'ethereum:',
					title: 'Custom Network Wallet',
					name: 'Custom Network (ETH)',
					logo: 'ethereum.png',
					chainId: 31337,
					nodes: [
						'http://localhost:8545',
					],
					ticker: 'ETH',
					decimals: 18,
					explorer: 'https://etherscan.io',
					fallbackGas: {
						maxFeePerGas: '1',
						maxPriorityFeePerGas: '0.001',
					},
				},
			};

			// Messages
			let messages;

			function initMessages() {
				return {
					'settings': {
						'typeSwitched': function (type) {
							return `${getText('address-type-changed')} <b>${type}</b>`;
						},
						'backendSwitched': function (url) {
							return `${getText('backend-switched')} <b>${url}</b>`;
						},
						'backendNotWorking': function (url) {
							return `<b>${url}</b ${getText('backend-down')}`;
						}
					},
					'error': {
						'bad-utxo': getText('bad-utxo'),
						'wallet-open-failed': getText('wallet-open-failed'),
						'balance-load-failed': getText('balance-load-failed'),
						'not-enough-funds': getText('not-enough-funds'),
						'unsupported-wallet': getText('unsupported-wallet'),
						'not-valid-public-key': getText('not-valid-public-key'),
						'not-valid-address': getText('not-valid-address'),
						'not-valid-token-address': getText('not-valid-token-address'),
						'not-valid-amount': getText('not-valid-amount'),
						'not-valid-fee': getText('not-valid-fee'),
						'bad-priv-key': getText('bad-priv-key'),
						'bad-mnemonic': getText('bad-mnemonic'),
						'not-enough-utxo': getText('not-enough-utxo'),
						'broadcast-failed': getText('broadcast-failed'),
						'pass-not-match': getText('pass-not-match'),
						'pass-too-short': getText('pass-too-short'),
						'bad-email': getText('bad-email'),
						'small-fee': getText('small-fee') + ' ' + getConfig()['fee'] + ' ' + getConfig()['ticker'] + '!'
					},
					'tx': {
						'loading-utxo': getText('loading-utxo'),
						'generating': getText('transaction-creation'),
						'sending': getText('transaction-sending'),
						'success': getText('transaction-broadcasted'),
					},
					'title': {
						'sure': getText('send-sure'),
						'processing': getText('send-processing'),
						'success': getText('success'),
						'failed': getText('failed')
					},
					'misc': {
						'outputAdded': function (address) {
							return getText('address') + ' ' + '<b class="break-word">' + address + '</b>' + ' ' + getText('outputs-added');
						}
					}
				};
			}

			function initKeys() {
				$('[tkey]').each(function() {
					const config = getConfig();

					let text = $(this).attr('tkey');

					switch (text) {
					case 'view-key':
						if (config.isBtc) {
							text = 'created-public-key';
							break;
						} else if (config.isEth) {
							text = 'address-key';
							break;
						}
						break;
					case 'optional-data':
						if (config.isBtc) {
							text = 'return-data';
							break;
						} else if (config.isEth) {
							text = 'input-data';
							break;
						}
						break;
					}
					
					if (['INPUT', 'TEXTAREA'].indexOf($(this).prop('tagName')) >= 0) {
						$(this).attr('placeholder', getText(text));
					} else {
						$(this).html(getText(text));
					}
				});
			}

			/**
			 * Draw table body
			 * 
			 * input should be
			 * 
			 * getTbody(
			 * [1, 2, 3],
			 * [4, 5, 6]
			 * );
			 */
			function getTbody(...array) {
				return `<tbody>
					${array.map(row => `<tr>
						${row.map(element => `<td>${element}</td>`).join('\n')}
					</tr>`).join('\n')}
				</tbody>`;
			}

			// Get current wallet language translation token
			function getText(token) {
				return walletLanguages[settings.language]?.[token] || walletLanguages[DEFAULT_LANGUAGE][token];
			}

			// Get current network config
			function getConfig() {
				const { network, node } = settings;

				const config = {...networkConfigs[network || DEFAULT_NETWORK]};

				if (config.network) {
					config.isBtc = true;
				} else if (config.chainId) {
					config.isEth = true;
				}

				config.node = node;

				return config;
			}

			const DEFAULT_FEE = 'fast';

			const feeMultipliers = {
				fastest: 5,
				fast: 2,
				medium: 1.5,
				slow: 1,
			};

			function getFeeMultiplier() {
				return feeMultipliers[settings.feeMultiplier || DEFAULT_FEE];
			}

			const feePriorities = {
				default: undefined,
				fast: ethers.parseUnits('0.0001', 'gwei'),
				op: 100n,
			};

			function getFeePriority() {
				return feePriorities[settings.feePriority || 'default'];
			}

			const DEFAULT_ADDRTYPE = 'legacy';

			const addressTypes = ['taproot', 'bech32', 'segwit', 'legacy'];

			// Get current address type
			async function getAddressType() {
				return await localDB.get('addrType') || DEFAULT_ADDRTYPE;
			}

			async function loadAddressType() {
				try {
					$('.address-type-select').empty();

					addressTypes.forEach(type => {
						$('.address-type-select').append($('<option>', {
							'value': type,
							'text': type,
						}));
					});

					$('.address-type-select').val(await getAddressType());

				} catch (error) {
					console.log(error);
					showMessage(`Failed to load address type: ${error.message}`);
				}
			}

			// Switch address type
			async function switchAddressType(type) {
				if (addressTypes.includes(type)) {
					await localDB.set('addrType', type);

					const changedType = await getAddressType();

					$('.address-type-select').val(changedType);
					showMessage(messages.settings.typeSwitched(changedType));
				}
			}

			async function loadSettings() {
				try {
					const browserLang =  navigator.language?.substr(0, 2);

					const language = (await localDB.get('language')) || (walletLanguages[browserLang] ? browserLang : DEFAULT_LANGUAGE);

					const feeMultiplier = (await localDB.get('feeMultiplier')) || DEFAULT_FEE;

					const feePriority = (await localDB.get('feePriority')) || 'default';

					// Display language
					if ($('#wallet-language-select > option').length !== Object.keys(walletLanguages).length) {
						$('#wallet-language-select').empty();

						Object.entries(walletLanguages).forEach(([lang, { ['lang-alias']: langAlias }]) => {
							$('#wallet-language-select').append($('<option>', {
								'value': lang,
								'text': langAlias
							}));
						});
					}

					// Update language on components
					if (settings.language !== language) {
						settings.language = language;

						$('#wallet-language-select').val(language);
						initKeys();
						messages = initMessages();
						$('#wallet-fee-select').empty();
					}

					// Display feeMultipliers
					if ($('#wallet-fee-select > option').length !== Object.keys(feeMultipliers).length) {
						$('#wallet-fee-select').empty();

						Object.keys(feeMultipliers).forEach(key => {
							$('#wallet-fee-select').append($('<option>', {
								'value': key,
								'text': getText(key),
							}));
						});
					}

					// Update feeMultiplier on components
					if (settings.feeMultiplier !== feeMultiplier) {
						settings.feeMultiplier = feeMultiplier;

						$('#wallet-fee-select').val(feeMultiplier);
					}

					// Display feePriorities
					if ($('#wallet-fee-priority > option').length !== Object.keys(feePriorities).length) {
						$('#wallet-fee-priority').empty();

						Object.keys(feePriorities).forEach(key => {
							$('#wallet-fee-priority').append($('<option>', {
								'value': key,
								'text': key,
							}));
						});
					}

					// Update feePriority on components
					if (settings.feePriority !== feePriority) {
						settings.feePriority = feePriority;

						$('#wallet-fee-priority').val(feePriority);
					}

				} catch (error) {
					console.log(error);
					showMessage(`Failed to load settings: ${error.message}`);
				}
			}

			async function saveSettings() {
				try {
					const network = settings.network;

					let node = $('#wallet-backend-selected').val();

					if (node === 'custom') {
						node = $('#wallet-custom-backend').val();

						$('#wallet-custom-backend').val('');
					}

					const language = $('#wallet-language-select').val();

					const feeMultiplier = $('#wallet-fee-select').val();

					const feePriority = $('#wallet-fee-priority').val();

					await localDB.set(`${network}_node`, node);
					await localDB.set('language', language);
					await localDB.set('feeMultiplier', feeMultiplier);
					await localDB.set('feePriority', feePriority);

					if (settings.node !== node) {
						await loadNode();
					}

					if (
						settings.language !== language ||
						settings.feeMultiplier !== feeMultiplier ||
						settings.feePriority !== feePriority
					) {
						await loadSettings();

						showMessage('Updated settings');
					}

				} catch (error) {
					console.log(error);
					showMessage(`Failed to save settings: ${error.message}`);
				}
			}

			async function loadNode(refreshNodes = false) {
				try {
					const network = settings.network;

					const config = networkConfigs[network];

					const node = (await localDB.get(`${network}_node`)) || config.nodes[0];

					// Display node list
					const hasCustomNode = !config.nodes.includes(node) && !['offline', 'custom'].includes(node);
					const nodesLength = hasCustomNode ? config.nodes.length + 1 : config.nodes.length;

					if ($('#wallet-backend-selected > option').length !== nodesLength || refreshNodes) {
						$('#wallet-backend-selected').empty();

						config.nodes.forEach(key => {
							$('#wallet-backend-selected').append($('<option>', {
								'value': key,
								'text': key
							}));
						});

						if (hasCustomNode) {
							$('#wallet-backend-selected').append($('<option>', {
								'value': node,
								'text': node
							}));
						}
						$('#wallet-backend-selected').append($('<option>', {
							'value': 'offline',
							'text': 'Offline (For signing)'
						}));
						$('#wallet-backend-selected').append($('<option>', {
							'value': 'custom',
							'text': 'Custom Backend'
						}));
					}

					// Update node on components
					if (settings.node !== node) {
						settings.node = node;

						closeWallet();
						$('#wallet-backend-selected').val(node);
						showMessage(messages.settings.backendSwitched(node));
					}

				} catch (error) {
					console.log(error);
					showMessage(`Failed to load node: ${error.message}`);
				}
			}

			async function loadNetwork() {
				try {
					const network = (await localDB.get('network')) || DEFAULT_NETWORK;

					const config = networkConfigs[network];

					// Display networks
					if ($('#network-list .dropdown-item').length !== Object.keys(networkConfigs).length) {
						$('#network-list').empty();

						Object.entries(networkConfigs).forEach(([key, { name }]) => {
							$('#network-list').append($('<a>', {
								'class': 'dropdown-item',
								'href': `#/network/${key}`,
								'text': name,
							}));
						});
					}

					if (settings.network !== network) {
						$('#network-versions').text(config.name);
						$('#network-list .dropdown-item').removeClass('active');
						$(`#network-list .dropdown-item:contains("${config.name}")`).addClass('active');

						if (config.network) {
							$('.btc-only').show();
							$('.eth-only').hide();
						} else if (config.chainId) {
							$('.btc-only').hide();
							$('.eth-only').show();
						}

						$('#coin-logo').attr('src', embedded[config.logo]);
						$('#coin-favicon').attr('href', embedded[config.logo]);
						$('#coin-title').text(config.title);

						settings.network = network;

						await loadNode(true);

						initKeys();
					}

				} catch (error) {
					console.log(error);
					showMessage(`Failed to load network: ${error.message}`);
				}
			}

			async function saveNetwork(network, page = '') {
				try {
					network = network.toUpperCase();

					if (networkConfigs[network] && settings.network !== network) {
						closeWallet();
						
						await localDB.set('network', network);

						await loadNetwork();
					}

					switchPage(page);

				} catch (error) {
					console.log(error);
					showMessage(`Failed to save network: ${error.message}`);
				}
			}

			// SPA router function
			function routePage() {
				const urlParams = readParams();
				if (window.location.hash === '') {
					window.location.replace(window.location.href.split('#')[0] + '#/');
				}

				if (urlParams[0] === '#') {
					const pageName = urlParams[1] || 'homepage';
					const templateName = `#${pageName}`;
						
					$('.router-link').removeClass('active');
					$(`.router-link[data-route=${pageName}]`).addClass('active');
					if ($('.router-page:visible').attr('id') !== urlParams[1]) {
						$('div.router-page').hide();
						if ($(templateName).length) {
							$(templateName).show();
						}
					}

					switch(pageName) {
					// Home page ¯\_(ツ)_/¯
					case 'homepage':
						setHomeTitle();
						break;

					case 'create':
						setTitle(getText('create-wallet'));
						break;

					case 'broadcast':
						setTitle(getText('broadcast-transaction'));
						break;

					case 'settings':
						setTitle(getText('wallet-settings'));
						break;

						// Swith network
					case 'network':
						if (urlParams[2]) {
							saveNetwork(urlParams[2]);
						}

						break;

					default:
						switchPage();

						break;
					}
				}
			}

			// Switch router page
			function switchPage(url = '', params = []) {
				params = params.length > 0 ? `/${params.join('/')}` : '';
				window.location.hash = `#/${url}${params}`;
			}

			// Read URL params
			function readParams() {
				return window.location.hash.split('/');
			}

			// Set window title
			function setTitle(title) {
				document.title = `${title} | ${getConfig()['title']}`;
			}

			function hide(element) {
				if (!$(element).hasClass('d-none')) {
					$(element).addClass('d-none');
				}
			}
			
			function show(element) {
				if ($(element).hasClass('d-none')) {
					$(element).removeClass('d-none');
				}
			}

			// Show big error message at the top of the page :D 
			function showMessage(message, hide = true) {
				$('#error-message').html(message);
				$('#error-message').removeClass('d-none');
				if (hide) {
					setTimeout(function() {
						$('#error-message').addClass('d-none');
					}, 3400);
				}
			}

			function hideMessage() {
				$('#error-message').addClass('d-none');
			}

			function showConfirm(title, context, table) {
				// Show modal
				if (!$('#send-modal').is(':visible')) {
					$('#send-modal').modal('toggle');
				}

				// Show screen
				show('#confirm-screen');
				hide('#status-screen');
				
				// Show title
				$('#send-title').text(title);

				// Show context
				$('#confirm-context').empty();
				if (context) {
					$('#confirm-context').append(context);
				}

				// Show table
				$('#confirm-table').empty();
				if (table) {
					$('#confirm-table').append(table);
				}

				// Show buttons
				hide('#send-create');
				hide('#send-sign');
				show('#send-confirm');

				$('#send-confirm').attr('onclick', '');
				$('#send-confirm').text('');
			}

			function showConfirmation(title, context, table) {
				showConfirm(title, context, table);

				show('#send-create');
				show('#send-sign');

				$('#send-confirm').attr('onclick', 'sendTransaction()');
				$('#send-confirm').text(getText('send-it'));
			}

			function showStatus(title, context) {
				// Show modal
				if (!$('#send-modal').is(':visible')) {
					$('#send-modal').modal('toggle');
				}

				// Show screen
				hide('#confirm-screen');
				show('#status-screen');

				// Show title
				$('#send-title').text(title);

				// Show context
				$('#status-context').empty();
				if (context) {
					$('#status-context').append(context);
				}

				// Show buttons
				hide('#send-create');
				hide('#send-sign');
				hide('#send-confirm');
			}

			function showQrAddress(text) {
				$('#qr-code-addres').empty();
				$('#qr-code-addres').qrcode(text);
			}

			// Set title
			function setHomeTitle() {
				if (globalData.signer?.address) {
					setTitle(getText('address') + ' ' + globalData.signer.address);
				} else {
					setTitle(getText('open-wallet'));
				}
			}

			async function getTokenList() {
				try {
					tokenlist = await geckoTokens.getTokenList(TOKEN_LIST);
				} catch {
					console.log('Failed to fetch token list, token balance may not be fetched');
				}
			}

			function validateAddress(address) {
				try {
					const config = getConfig();
					
					if (config.isBtc) {
						bitcoin.address.toOutputScript(address, config.network);
					} else if (config.isEth) {
						ethers.getAddress(address);
					}

					return true;
				} catch {
					return false;
				}
			}

			function getProviderBtc() {
				const config = getConfig();
				const isMempool = MEMPOOL_INSTANCES.some(i => config.node.includes(i));

				const provider = !isMempool
					? new btcSigner.CoinProvider(config.node)
					: new btcSigner.MempoolProvider(config.node);

				globalData.provider = provider;

				return provider;
			}

			async function getProviderEth() {
				const config = getConfig();

				if (config.node === 'offline') {
					const staticNetwork = new ethers.Network('mainnet', BigInt(config.chainId));

					const provider = new ethExt.Provider('http://localhost:8545', staticNetwork, {
						staticNetwork,
					});

					globalData.provider = provider;

					return provider;
				}

				const provider = new ethExt.Provider(config.node, undefined, {
					chainId: config.chainId !== 31337 ? BigInt(config.chainId) : undefined,
					pollingInterval: 10000,
					// Ensure enough time for token balance call aggregation
					batchStallTime: 120,
				});

				// Auto detect op stack chains for custom network
				if (config.chainId === 31337) {
					if ((await provider.getCode(ethExt.GAS_PRICE_ORACLE_ADDRESS)) !== '0x') {
						provider.isOpStack = true;
					}
				}

				globalData.provider = provider;

				return provider;
			}

			async function getProvider() {
				if (globalData.provider) {
					return globalData.provider;
				}

				const config = getConfig();

				if (config.isBtc) {
					return getProviderBtc();
				} else if (config.isEth) {
					return await getProviderEth();
				}
			}

			async function walletBalanceBtc() {
				const config = getConfig();
				const cachedBalance = await globalData.signer.getBalance();

				const { feePerByte, utxoBalance, coinbase } = cachedBalance;

				globalData.cachedBalance = cachedBalance;
				globalData.balance = utxoBalance;

				$('.fee-rate').text(`${feePerByte} sat/vByte`);
				$('.wallet-amount').text(btcSigner.formatCoins(utxoBalance));
				$('.wallet-ticker').text(config.ticker);
				$('.coinbase-amount').text(coinbase ? btcSigner.formatCoins(coinbase) : '0');
			}

			async function walletBalanceEth() {
				const config = getConfig();

				const chainTokens = tokenlist?.tokens.filter(t => t.chainId === config.chainId);

				const provider = globalData.provider;
				const signer = globalData.signer;

				const [{ chainId }, feeData, blockNumber, ethBalance, ...tokenBalances] = await Promise.all([
					provider.getNetwork(),
					provider.getFeeData(),
					provider.multicall.getBlockNumber(),
					provider.multicall.getEthBalance(signer.address),
					...(chainTokens.map(async ({ logoURI, name, symbol, decimals, address }) => {
						const balance = await ethExt.ERC20__factory.connect(address, provider).balanceOf(signer.address);

						if (balance) {
							const tokenStr = `<img src="${logoURI}" alt="${name}" height="24">  ${name} (${symbol})`;
							const balanceStr = `${ethers.formatUnits(balance, decimals)} ${symbol}`;

							return {
								token: tokenStr,
								tokenAddress: address,
								balance: balanceStr,
							};
						}
					})),
				]);
				
				const { gasPrice, maxFeePerGas, maxPriorityFeePerGas } = feeData;
				
				const gasPriceText = ethers.formatUnits(maxFeePerGas ? maxFeePerGas + maxPriorityFeePerGas : gasPrice, 'gwei');
				const priorityFee = ethers.formatUnits(maxPriorityFeePerGas || 0n, 'gwei');
				
				// update balance
				globalData.balance = ethBalance;

				$('.fee-rate').text(`${gasPriceText} gwei`);
				$('.wallet-amount').text(ethers.formatUnits(ethBalance, config.decimals));
				$('.wallet-ticker').text(config.ticker);

				// update erc20 balances
				const tokenData = tokenBalances.filter(t => t);

				globalData.tokenTable.clear();
				globalData.tokenTable.rows.add(tokenData);
				globalData.tokenTable.draw();

				if (chainTokens.length) {
					console.log(`Got ${tokenData.length} tokens for ${Number(chainId)} chain (Out of ${chainTokens.length})`);
				}

				console.log(`RPC: ${config.node}, Network: ${Number(chainId)}, Block ${blockNumber}, GasPrice: ${gasPriceText} gwei, PriorityFee: ${priorityFee} gwei`);
			}

			// Refresh UTXO list and wallet balance
			function walletBalance() {
				const config = getConfig();

				if (config.isBtc) {
					return walletBalanceBtc();
				} else if (config.isEth) {
					return walletBalanceEth();
				}
			}

			/**
			 * Open Card
			 */
			async function getEmailLegacy() {
				const email = $('#open-email').val().toLowerCase();
				const pass = $('#open-password').val();
				const passConfirm = $('#open-password-confirm').val();

				if (!email.match(/[\s\w\d]+@[\s\w\d]+/g) || !(email.length >= 5)) {
					throw new Error(messages.error['bad-email']);
				}

				if (!pass.length >= 5) {
					throw new Error(messages.error['pass-too-short']);
				}

				if (pass !== passConfirm) {
					throw new Error(messages.error['pass-not-match']);
				}

				return await btcSigner.generateHexWithIdLegacy(email, pass);
			}

			async function getEmailBip39() {
				const email = $('#bip39-email').val().toLowerCase();
				const pass = $('#bip39-password').val();
				const passConfirm = $('#bip39-password-confirm').val();
				
				const thirdParams = $('#bip39-third-params').val()
					? $('#bip39-third-params').val().replaceAll(', ', ',').split(',').filter(a => a)
					: undefined;
				const nonce = parseInt($('#bip39-nonce').val()) || 0;
				
				const mnemonicLength = parseInt($('#bip39-mnemonic-length').val()) || undefined;
				const mnemonicIndex = parseInt($('#bip39-mnemonic-index').val()) || 0;
				
				if (!email.match(/[\s\w\d]+@[\s\w\d]+/g) || !(email.length >= 5)) {
					throw new Error(messages.error['bad-email']);
				}

				if (!pass.length >= 5) {
					throw new Error(messages.error['pass-too-short']);
				}
				
				if (pass !== passConfirm) {
					throw new Error(messages.error['pass-not-match']);
				}

				const { mnemonic } = await btcSigner.generateMnemonicWithId(
					email,
					pass,
					thirdParams,
					mnemonicLength,
					nonce
				);

				return {
					mnemonic,
					mnemonicIndex,
				};
			}

			async function getViewOnly() {
				const config = getConfig();

				const address = $('#view-only-address').val().trim();

				if (config.isBtc) {
					if (address.length !== 66) {
						throw new Error(messages.error['not-valid-public-key']);
					}

					return address;
				} else if (config.isEth) {
					const provider = await getProvider();

					if (address.endsWith('.eth')) {
						return await provider.resolveName(address);
					}

					if (address.length !== 42) {
						throw new Error(messages.error['not-valid-address']);
					}

					return ethers.getAddress(address);
				}
			}

			function getMnemonic() {
				const mnemonic = $('#mnemonic').val().trim();
				const mnemonicIndex = parseInt($('#mnemonic-index').val()) || 0;
				
				try {
					ethers.Mnemonic.fromPhrase(mnemonic);

					return {
						mnemonic,
						mnemonicIndex,
					};
				} catch {
					throw new Error(messages.error['bad-mnemonic']);
				}
			}

			async function getPrivateKey() {
				const config = getConfig();

				if (config.isBtc) {
					const privateKey = $('#private-key').val().trim();
					
					const wif = privateKey.split(':')[1] || privateKey.split(':')[0];
					const wifPrefix = privateKey.split(':')[0];
					
					if (btcSigner.electrumKeys[wifPrefix]) {
						await switchAddressType(btcSigner.electrumKeys[wifPrefix]);
					}

					if (![51, 52].includes(wif.length)) {
						throw new Error(messages.error['bad-priv-key']);
					}

					return wif;

				} else if (config.isEth) {
					let wif = $('#private-key').val().trim();

					if (wif.length === 64) {
						wif = '0x' + wif;
					}

					if (wif.length !== 66) {
						throw new Error(messages.error['bad-priv-key']);
					}

					return wif;
				}
			}

			async function getBtcSigner(keyType) {
				const provider = await getProvider();
				const config = getConfig();

				const walletOptions = {
					network: config.network,
					addrType: await getAddressType(),

					feeMultiplier: () => {
						return getFeeMultiplier();
					},
				};

				let signer;

				if (keyType === 'email') {
					const legacyKey = await getEmailLegacy();

					const bufferKey = bitcoin.Buffer.from(legacyKey.substring(2), 'hex');

					signer = btcSigner.CoinWallet.fromBuffer(
						bufferKey,
						provider,
						walletOptions,
					);

				} else if (keyType === 'bip39' || keyType === 'mnemonic') {
					const { mnemonic, mnemonicIndex } = keyType === 'bip39'
						? await getEmailBip39()
						: getMnemonic();

					signer = new btcSigner.MnemonicWallet(
						mnemonic,
						provider,
						{
							...walletOptions,
							mnemonicIndex,
						},
					);

				} else if (keyType === 'viewOnly') {
					const publicKey = await getViewOnly();

					signer = new btcSigner.VoidWallet(
						publicKey,
						provider,
						walletOptions,
					);

				} else if (keyType === 'privateKey') {
					const privateKey = await getPrivateKey();

					signer = new btcSigner.CoinWallet(
						privateKey,
						provider,
						walletOptions,
					);
				}

				globalData.signer = signer;

				const redeemScript = bitcoin.address.toOutputScript(
					signer.address,
					config.network
				);

				return {
					signer,
					script: redeemScript.toString('hex'),
				};
			}

			async function getEthSigner(keyType) {
				const provider = await getProvider();
				const config = getConfig();

				const signerOptions = {
					gasPriceBump: () => {
						return getFeeMultiplier();
					},
					customPriorityFee: () => {
						return getFeePriority();
					},
					opGasPriceOracle: config.opGasPriceOracle ||
						(provider.isOpStack ? ethExt.GAS_PRICE_ORACLE_ADDRESS : undefined),
				};

				let signer;

				if (keyType === 'email' || keyType === 'privateKey') {
					const privateKey = keyType === 'email'
						? await getEmailLegacy()
						: await getPrivateKey();

					signer = new ethExt.Wallet(privateKey, provider, signerOptions);

				} else if (keyType === 'bip39' || keyType === 'mnemonic') {
					const { mnemonic, mnemonicIndex } = keyType === 'bip39'
						? await getEmailBip39()
						: getMnemonic();

					signer = ethExt.Wallet.fromMnemonic(mnemonic, provider, mnemonicIndex, signerOptions);
					
					signer.mnemonic = mnemonic;
					signer.mnemonicIndex = mnemonicIndex;

				} else if (keyType === 'browser') {
					// Fetch network before connecting to browser provider
					await provider.getNetwork();

					// handle metamask event with timeout
					const browserCallBack =  () => {
						if (globalData.walletTimeout) {
							return;
						}
						
						globalData.walletTimeout = setTimeout(() => {
							closeWallet();
							
							globalData.walletTimeout = null;
						}, 500);
					};

					globalData.walletTimeout = true;

					const browserProviders = await ethExt.BrowserProvider.discoverProviders(provider, {
						...signerOptions,

						// Chain params
						chainName: config.name,
						chainSymbol: config.ticker,
						rpcUrl: config.node,
						explorerUrl: config.explorer,

						// Wallet disconnection
						chainChanged: browserCallBack,
						accountsChanged: browserCallBack,
						disconnect: browserCallBack,
					});

					const providerName = $('#wallet-select').val();

					const browserProvider = browserProviders.find(({ providerInfo }) => providerInfo?.name === providerName);

					if (!providerName || !browserProvider) {
						throw new Error('Browser provider not found');
					}

					signer = await browserProvider.getSigner(0);

					// Prevent immediate wallet disconnection
					setTimeout(() => {
						globalData.walletTimeout = null;
					}, 2000);

				} else if (keyType === 'viewOnly') {
					const address = await getViewOnly();

					signer = new ethExt.VoidSigner(address, provider, signerOptions);

				}

				globalData.signer = signer;

				return signer;
			}

			async function openWallet(keyType) {
				try {
					showMessage(getText('opening-wallet'), false);

					const config = getConfig();
					const isOffline = config.node === 'offline';

					let signer, script;

					if (config.isBtc) {

						({ signer, script } = await getBtcSigner(keyType));

					} else if (config.isEth) {

						signer = await getEthSigner(keyType);
					}

					if (!isOffline) {
						showMessage(getText('loading-balance'), false);

						await walletBalance();

						globalData.walletInterval = setInterval(async () => {
							try {
								if (globalData.walletSyncing) {
									return;
								}

								globalData.walletSyncing = true;

								await walletBalance();

							} catch {
								showMessage(messages.error['balance-load-failed']);
							}

							globalData.walletSyncing = false;
						}, 20000);
					}

					// Clear messages and inputs
					hideMessage();
					$('.open-card input').val('');

					// Update wallet card
					showQrAddress(`${config.uri}${signer.address}`);
					$('#wallet-address').html(signer.address);
					$('#history-link').attr('href', `${config.explorer}/address/${signer.address}`);

					$('#wallet-keys-mnemonic').val(signer.mnemonic || '');
					$('#wallet-keys-address').val(signer.address);
					$('#wallet-keys-pubkey').val(
						config.isBtc
							? (signer.publicKey || '')
							: config.isEth
								? (signer.signingKey?.compressedPublicKey || '')
								: ''
					);
					$('#wallet-keys-privkey').val(
						config.isBtc
							? (signer.privateKeyWithPrefix || '')
							: config.isEth
								? (signer.privateKey || '')
								: ''
					);
					$('#wallet-keys-script').val(script || '');

					// Show wallet card
					$('.before-open').addClass('d-none');
					$('.on-open').removeClass('d-none');
					setHomeTitle();

				} catch (error) {
					console.log(error);
					closeWallet();
					showMessage(`${messages.error['wallet-open-failed']}: ${error.message}`);
				}
			}

			// Close wallet
			function closeWallet() {
				$('.before-open').removeClass('d-none');
				$('.on-open').addClass('d-none');

				// Empty wallet card
				$('#wallet-address').html('');
				$('#history-link').attr('href', '');

				$('.wallet-amount').text('');
				$('.wallet-ticker').text(getText('loading'));
				$('.coinbase-amount').text('');

				$('.wallet-keys input').val('');

				globalData.clear();
				resetTxForm();
				setHomeTitle();
			}

			/**
			 * Send Card
			 */
			function stopStream() {
				if (stream) {
					stream.getTracks().forEach(function(track) {
						track.stop();
					});
				}
			}

			function startStream() {
				const canvasElement = document.getElementById('scan-canvas');
				const canvas = canvasElement.getContext('2d');
				const video = document.createElement('video');
				canvasElement.hidden = true;

				$('#loading-message').text(getText('webcam-message'));
				$('#loading-message').removeClass('d-none');

				// Use facingMode: environment to attemt to get the front camera on phones
				navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(function(gstream) {
					stream = gstream;
					video.srcObject = stream;
					video.setAttribute('playsinline', true);
					video.play();
					requestAnimationFrame(tick);
				});

				function tick() {
					const config = getConfig();

					$('#loading-message').text(getText('webcam-loading'));
					let stop = false;
					if (video.readyState === video.HAVE_ENOUGH_DATA) {
						$('#loading-message').addClass('d-none');
						canvasElement.hidden = false;

						canvasElement.height = video.videoHeight;
						canvasElement.width = video.videoWidth;
						canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
						const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
						const code = jsQR(imageData.data, imageData.width, imageData.height, {
							inversionAttempts: 'dontInvert',
						});
						
						if (code) {
							let address = code.data;

							if (address.startsWith(config.uri)) {
								address = address.replace(config.uri, '');
							}

							if (validateAddress(address)) {
								if (config.isBtc && $('#send-outputs input[name="send-address"]').last().val()) {
									$('#add-output').click();
								}

								$('#send-outputs input[name="send-address"]').last().val(address);
								showMessage(messages.misc.outputAdded(address));
								stop = true;
							}
						}
					}

					if (!stop) {
						requestAnimationFrame(tick);
					} else {
						$('#scan-modal').modal('toggle');
						stopStream();
					}
				}
			}

			function showScanModal() {
				// $('#scan-canvas').addClass('d-none')
				$('#scan-modal').modal('toggle');
				startStream();
			}

			async function getMaxSpendable(changeAddress) {
				try {
					const config = getConfig();

					if (config.isBtc) {
						return btcSigner.formatCoins(
							await globalData.signer.getMaxSpendable({
								changeAddress,
								cachedBalance: globalData.cachedBalance
							})
						);

					// populateEth function should be able to calculate full spendable balance excluding fees
					// So we specify the full balance here
					} else if (config.isEth) {
						return ethers.formatUnits(globalData.balance, config.decimals);
					}
				// If we have less than fees
				} catch {
					return 0;
				}
			}

			async function populateBtc() {
				try {
					// 1. Show UTXO build status
					showStatus(messages.tx['generating'], messages.tx['generating']);
					
					globalData.resetTx();

					const config = getConfig();

					const outputs = [];

					$.each($('#send-outputs .send-outputs-item'), (key, item) => {
						const address = $('[name="send-address"]', item).val().trim();
						const value = btcSigner.parseCoins($('[name="send-amount"]', item).val() || 0);

						if ((!value && value !== 0) || value < 0) {
							throw new Error(messages.error['not-valid-amount']);
						}

						if (!validateAddress(address)) {
							throw new Error(messages.error['not-valid-address']);
						}

						outputs.push({
							address,
							value,
						});
					});

					if ($('#optional-data').val()) {
						outputs.push({
							returnData: $('#optional-data').val(),
							value: 0,
						});
					}

					const outputsCoins = Number(outputs.reduce((acc, curr) => acc + curr.value, 0));

					if ((!outputsCoins && outputsCoins !== 0) || outputsCoins < 0) {
						throw new Error(messages.error['not-valid-amount']);
					}

					// 2. Show UTXO population status
					showStatus(messages.tx['generating'], messages.tx['loading-utxo']);

					const tx = await globalData.signer.populateTransaction(outputs, {
						cachedBalance: globalData.cachedBalance,
					});

					await globalData.signer.populatePsbt(tx);

					console.log('TX:', tx);

					globalData.tx = tx;

					// 2. Show confirmation screen
					/* eslint-disable indent */
					showConfirmation(
						getText('send-sure'),
						`<span>${getText('send-warning')}</span> `
						+ `<strong>${btcSigner.formatCoins(outputsCoins)} ${config.ticker} (Fees: ${tx.fees} ${config.ticker})</strong>. `
						+ `<span>${getText('send-warning-reverse')}</span>`,
						`
						<table class="table table-bordered">
							${getTbody(
								['Network', config.name],
								['Input Amounts', `${tx.inputAmounts} ${config.ticker}`],
								['Output Amounts', `${tx.outputAmounts} ${config.ticker}`],
								...(tx.outputs.map((output, i) => 
								[`Output ${i} (${output.address})`, `${btcSigner.formatCoins(output.value)} ${config.ticker}`]
								)),
								['Value', `${btcSigner.formatCoins(outputsCoins)} ${config.ticker}`],
								['Fees', `${tx.fees} ${config.ticker} (${btcSigner.parseCoins(tx.fees) / tx.vBytes} sat/vByte)`],
								['vBytes', tx.vBytes],
							)}
					    </table>
					    `
					);
					/* eslint-enable indent */
				} catch (error) {
					console.log(error);

					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			async function populateConsolidation() {
				try {
					// 1. Show UTXO build status
					showStatus(messages.tx['generating'], messages.tx['loading-utxo']);
					
					globalData.resetTx();

					const config = getConfig();

					const txs = await globalData.signer.populateConsolidation({
						cachedBalance: globalData.cachedBalance,
					});

					const fees = txs.reduce((acc, curr) => acc + Number(curr.fees), 0);

					console.log('TX:', txs);

					const inputLength = txs.reduce((acc, tx) => acc + tx.inputs.length, 0);

					globalData.tx = txs;

					// 2. Show confirmation screen
					showConfirmation(
						getText('send-sure'),
						`<span>${getText('send-warning')}</span> `
						+ `<strong>${inputLength} inputs (Consolidation Txs: ${txs.length}, Fees: ${fees} ${config.ticker})</strong>. `
						+ `<span>${getText('send-warning-reverse')}</span>`
					);

				} catch (error) {
					console.log(error);

					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			async function populateEth() {
				try {
					// 1. Show UTXO build status
					showStatus(messages.tx['generating'], messages.tx['generating']);

					globalData.resetTx();

					const config = getConfig();

					let to;

					const toString = $('#send-outputs input[name="send-address"]').last().val();
					const data = $('#optional-data').val() || undefined;

					if (toString || !toString && !data) {
						try {
							to = ethers.getAddress(toString);
						} catch {
							throw new Error(messages.error['not-valid-address']);
						}
					}

					const valueString = $('#send-outputs input[name="send-amount"]').last().val() || '0';

					const value = ethers.parseEther(valueString);

					if (value < 0n) {
						throw new Error(messages.error['not-valid-amount']);
					}

					const tx = await globalData.signer.populateTransaction({
						to,
						value,
						data,
					});

					tx.valueString = `${valueString} ${config.ticker}`;

					console.log('TX:', tx);

					globalData.tx = tx;

					// 2. Show confirmation screen
					/* eslint-disable indent */
					showConfirmation(
						getText('send-sure'),
						`<span>${getText('send-warning')}</span> `
						+ `<strong>${tx.valueString} (Fees: ${ethers.formatUnits(tx.txCost, config.decimals)} ${config.ticker})</strong>. `
						+ `<span>${getText('send-warning-reverse')}</span>`,
						`
						<table class="table table-bordered">
							${getTbody(
								['Network', config.name],
								['ChainId', tx.chainId],
								['Nonce', tx.nonce],
								['From', tx.from],
								['To', to || getText('contract-creation')],
								['Value', tx.valueString],
								['GasLimit', tx.gasLimit],
								...(tx.maxFeePerGas ? [
								['MaxFeePerGas', `${ethers.formatUnits(tx.maxFeePerGas, 'gwei')} gwei`],
								['MaxPriorityFeePerGas', `${ethers.formatUnits(tx.maxPriorityFeePerGas, 'gwei')} gwei`],
								]: [
								['GasPrice', `${ethers.formatUnits(tx.gasPrice, 'gwei')} gwei`],
								]),
								...(tx.l1Fee ? [
								['L1 Fees', `${ethers.formatEther(tx.l1Fee)} ${config.ticker}`],
								] : []),
								['Tx Fee', `${ethers.formatUnits(tx.txCost, config.decimals)} ${config.ticker}`],
							)}
						</table>
						`
					);
					/* eslint-enable indent */

				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			/**
			 * ERC20 related
			 */
			async function getMaxToken() {
				try {
					let tokenAddress;

					try {
						tokenAddress = ethers.getAddress($('#send-token-contract').val());
					} catch {
						throw new Error(messages.error['not-valid-address']);
					}

					const token = ethExt.ERC20__factory.connect(tokenAddress, globalData.provider);

					const [balance, decimals] = await Promise.all([
						token.balanceOf(globalData.signer.address),
						token.decimals(),
					]);

					$('#send-token-amount').val(ethers.formatUnits(balance, decimals));

				} catch (error) {
					console.log(error);
					showMessage(`${messages.error['balance-load-failed']} ${error.message}`);
				}
			}

			async function populateToken() {
				try {
					showStatus(messages.tx['generating'], messages.tx['generating']);

					globalData.resetTx();

					const config = getConfig();

					let to, tokenAddress;

					try {
						to = ethers.getAddress($('#send-token-address').val());

						tokenAddress = ethers.getAddress($('#send-token-contract').val());
					} catch {
						throw new Error(messages.error['not-valid-address']);
					}

					const valueString = $('#send-token-amount').val() || '0';

					const token = ethExt.ERC20__factory.connect(tokenAddress, globalData.provider);

					const [balance, decimals, symbol] = await Promise.all([
						token.balanceOf(globalData.signer.address),
						token.decimals(),
						token.symbol(),
					]);

					const value = ethers.parseUnits(valueString, decimals);

					if (value > balance || value < 0n) {
						throw new Error(messages.error['not-valid-amount']);
					}

					const tx = await globalData.signer.populateTransaction(
						await token.transfer.populateTransaction(to, value)
					);

					tx.valueString = `${valueString} ${symbol}`;

					console.log('TX:', tx);

					globalData.tx = tx;

					// 2. Show confirmation screen
					/* eslint-disable indent */
					showConfirmation(
						getText('send-sure'),
						`<span>${getText('send-warning')}</span> `
						+ `<strong>${tx.valueString} (Fees: ${ethers.formatUnits(tx.txCost, config.decimals)} ${config.ticker})</strong>. `
						+ `<span>${getText('send-warning-reverse')}</span>`,
						`
						<table class="table table-bordered">
							${getTbody(
								['Network', config.name],
								['ChainId', tx.chainId],
								['Nonce', tx.nonce],
								['From', tx.from],
								['To', to],
								['Token Contract', tx.to],
								['Value', tx.valueString],
								['GasLimit', tx.gasLimit],
								...(tx.maxFeePerGas ? [
								['MaxFeePerGas', `${ethers.formatUnits(tx.maxFeePerGas, 'gwei')} gwei`],
								['MaxPriorityFeePerGas', `${ethers.formatUnits(tx.maxPriorityFeePerGas, 'gwei')} gwei`],
								]: [
								['GasPrice', `${ethers.formatUnits(tx.gasPrice, 'gwei')} gwei`],
								]),
								...(tx.l1Fee ? [
								['L1 Fees', `${ethers.formatEther(tx.l1Fee)} ${config.ticker}`],
								] : []),
								['Tx Fee', `${ethers.formatUnits(tx.txCost, config.decimals)} ${config.ticker}`],
							)}
						</table>
						`
					);
					/* eslint-enable indent */

				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			/**
			 * Compose transaction from form input and show modal
			 */
			function populateTransaction() {
				const config = getConfig();

				if (config.isBtc) {
					populateBtc();
				} else if (config.isEth) {
					populateEth();
				}
			}

			function parseTransaction() {
				try {
					showStatus(messages.tx['generating'], messages.tx['generating']);

					globalData.resetTx();

					const config = getConfig();

					let tx, formattedValue;

					if (config.isBtc) {
						tx = globalData.signer.parseTransaction($('#wallet-sign-input').val());

						formattedValue = `${tx.outputAmounts} ${config.ticker} (Fees: ${tx.fees} ${config.ticker})`;

					} else if (config.isEth) {
						tx = ethers.Transaction.from($('#wallet-sign-input').val()).toJSON();

						const gasPrice = tx.maxFeePerGas
							? BigInt(tx.maxFeePerGas) + BigInt(tx.maxPriorityFeePerGas)
							: BigInt(tx.gasPrice);

						formattedValue = `${ethers.formatUnits(tx.value, config.decimals)}  ${config.ticker}`
							+ ` (Fees: ${ethers.formatUnits(gasPrice * BigInt(tx.gasLimit), config.decimals)} ${config.ticker})`;
					}

					globalData.tx = tx;

					showConfirmation(
						getText('send-sure'),
						`<span>${getText('send-warning')}</span> `
						+ `<strong>${formattedValue}</strong>. `
						+ `<span>${getText('send-warning-reverse')}</span>`,
						`
						<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${JSON.stringify(tx, null, 2)}</textarea>
						</div>
					    `
					);

				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			/**
			 * Handle modal actions
			 */
			function createTransaction() {
				try {
					showStatus(getText('offline-tx'), messages.tx['generating']);

					const config = getConfig();

					// Consolidation tx
					if (config.isBtc && Array.isArray(globalData.tx)) {
						/* eslint-disable indent */
						showStatus(
							getText('offline-tx'),
							`<div class="mt-3">
								${globalData.tx.map(tx => 
									`<textarea class="form-control" readonly cols="30" rows="10">${tx.psbt.toHex()}</textarea>`
								).join('')}
							</div>`
						);
						/* eslint-enable indent */

						resetTxForm();
						return;
					}

					const serailizedTx = config.isBtc
						? globalData.tx.psbt.toHex()
						: config.isEth
							? ethers.Transaction.from({...globalData.tx, from: undefined}).unsignedSerialized
							: '';

					showStatus(
						getText('offline-tx'),
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${serailizedTx}</textarea>
						</div>`
					);

					resetTxForm();

				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			async function signTransaction() {
				try {
					showStatus(getText('signed-tx'), messages.tx['generating']);

					const config = getConfig();

					// Consolidation tx
					if (config.isBtc && Array.isArray(globalData.tx)) {
						/* eslint-disable indent */
						showStatus(
							getText('signed-tx'),
							`<div class="mt-3">
								${globalData.tx.map(tx => 
								`<textarea class="form-control" readonly cols="30" rows="10">
									${globalData.signer.signTransaction(tx.psbt).toHex()}
								</textarea>
								`).join('')}
							</div>`
						);
						/* eslint-enable indent */

						resetTxForm();
						return;
					}

					const signedTx = config.isBtc
						? globalData.signer.signTransaction(globalData.tx.psbt).toHex()
						: config.isEth
							? await globalData.signer.signTransaction(globalData.tx)
							: '';

					showStatus(
						getText('signed-tx'),
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${signedTx}</textarea>
						</div>`
					);

					resetTxForm();
				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			 
			async function sendTransaction() {
				try {			
					showStatus(messages.title['processing'], messages.tx['sending']);

					const config = getConfig();

					// Consolidation TX
					if (config.isBtc && Array.isArray(globalData.tx)) {
						const txs = globalData.tx;
						const txidContext = [];

						for (let i = 0; i < txs.length; ++i) {
							const tx = globalData.signer.signTransaction(txs[i].psbt);
							const txid = await globalData.provider.broadcastTransaction(tx.toHex());

							txidContext.push(`
								<a href="${`${config.explorer}/tx/${txid}`}" target="_blank" rel="noreferrer nofollow">
									${txid}
								</a>
							`);
						}

						showStatus(messages.title['success'], txidContext.join(''));

						resetTxForm();
						return;
					}

					const txid = config.isBtc
						? await globalData.provider.broadcastTransaction(
							globalData.signer.signTransaction(globalData.tx.psbt).toHex()
						)
						: config.isEth
							? (await globalData.signer.sendTransaction(globalData.tx)).hash
							: '';

					showStatus(
						messages.title['success'],
						`<a href="${`${config.explorer}/tx/${txid}`}" target="_blank" rel="noreferrer nofollow">
							${txid}
						</a>`
					);

					resetTxForm();
				} catch (error) {
					console.log(error);
					
					showStatus(
						messages.title['failed'],
						`<div class="mt-3">
							<textarea class="form-control" readonly cols="30" rows="10">${error.message}</textarea>
						</div>
						`
					);
				}
			}

			// Reset form
			function resetTxForm() {
				$('.send-additional-output').remove();
				$('.wallet-send input').val('');
				$('.token-send input').val('');
				globalData.resetTx();
			}

			async function createWallet() {
				const config = getConfig();
				const addrType = await getAddressType();

				if (config.isBtc) {
					const wallet = new btcSigner.MnemonicWallet(
						undefined,
						undefined,
						{
							network: config.network,
							addrType,
						}
					);

					$('#create-keys-mnemonic').val(wallet.mnemonic);
					$('#create-keys-address').val(wallet.address);
					$('#create-keys-pubkey').val(wallet.publicKey);
					$('#create-keys-privkey').val(wallet.privateKeyWithPrefix);

				} else if (config.isEth) {
					const wallet = ethers.HDNodeWallet.createRandom();

					$('#create-keys-mnemonic').val(wallet.mnemonic.phrase);
					$('#create-keys-address').val(wallet.address);
					$('#create-keys-pubkey').val(wallet.publicKey);
					$('#create-keys-privkey').val(wallet.privateKey);
				}
			}

			async function broadcastTransaction() {
				try {
					const config = getConfig();
					const provider = await getProvider();

					const signedTx = $('#transaction-broadcast-raw').val();

					const txid = config.isBtc
						? await provider.broadcastTransaction(signedTx)
						: config.isEth
							? (await provider.broadcastTransaction(signedTx)).hash
							: '';

					$('#transaction-broadcast-raw').val('');

					showMessage(`
						${messages.tx['success']}<a href="${`${getConfig()['explorer']}/tx/${txid}`}" target="_blank" rel="noreferrer nofollow" >` + txid + `</a>
					`);
				} catch (error) {
					console.log(error);
					showMessage(`${messages.error['broadcast-failed']} ${error.message}`);
				}
			}

			async function loadBrowserProviders() {
				try {
					$('#wallet-select').empty();

					(await ethExt.BrowserProvider.discoverProviders() || []).forEach(({ providerInfo }) => {
						$('#wallet-select').append($('<option>', {
							'value': providerInfo.name,
							'text': providerInfo.name,
						}));
					});
				} catch (error) {
					console.log(error);
					showMessage(`Failed to load browser providers: ${error.message}`);
				}
			}

			// All starts here
			$(document).ready(async function() {
				getTokenList();

				await localDB.db;
				await loadSettings();
				await loadNetwork();
				await loadAddressType();
				loadBrowserProviders();

				$('#wallet-version').text(WALLET_VERSION);

				routePage();

				globalData.tokenTable = $('#tokens-table').DataTable({
					autoWidth: false,
					columns: [
						{ data: 'token' },
						{ data: 'tokenAddress' },
						{ data: 'balance' },
					]
				});

				$('.tab-link').click(function(e) {
					e.preventDefault();

					const tabFamily = $(this).data('tab-family');
					const tabName = $(this).data('tab-name');

					$(`.${tabFamily}`).addClass('d-none');
					$(`.${tabName}`).removeClass('d-none');

					$(`.${tabFamily}-tabs .tab-link`).removeClass('active');
					$(this).addClass('active');
				});

				$(window).on('hashchange', routePage);
				if (window.location.hash) {
					$(window).trigger('hashchange');
				}

				// Check wallet balance on balance label click
				$('.update-balance').click(function(e){
					e.preventDefault();
					walletBalance();
				});

				$('.fill-balance').click(async (e) => {
					e.preventDefault();
					let firstAddress = $('[name="send-address"]', $('#send-outputs .send-outputs-item')[0]).val();
					if (!validateAddress(firstAddress)) {
						firstAddress = undefined;
					}
					const balance = await getMaxSpendable(firstAddress);
					$('[name="send-amount"]', $('#send-outputs .send-outputs-item')[0]).val(balance);
				});

				// Toggle private key visibility
				$('.toggle-priv-key').click(function(){
					if ($(this).text() == getText('show')) {
						$(this).parent().parent().find('.keys-privkey').attr('type', 'text');
						$(this).text(getText('hide'));
					} else {
						$(this).parent().parent().find('.keys-privkey').attr('type', 'password');
						$(this).text(getText('show'));
					}
				});

				// Add transaction output
				$('#add-output').click(function(e){
					$('#send-outputs').append(`
						<div class="send-additional-output send-outputs-item input-group mb-2">
							<input name="send-address" class="form-control" placeholder="${getText('enter-address')}" type="text">
							<input name="send-amount" class="form-control" placeholder="${getText('amount')}" type="text">
							<div class="input-group-append">
								<button class="btn btn-outline-danger remove-additional-output" type="submit">
									<span class="fa-solid fa-circle-minus"></span>
								</button>
							</div>
						</div>
					`);
					$('.remove-additional-output').click(function(e){
						$(this).closest('.send-additional-output').remove();
						e.preventDefault();
					});
					e.preventDefault();
				});

				// Change address type
				$('.address-type-select').on('change', async function (e) {
					try {
						e.preventDefault();
						await switchAddressType($(this).val());
					} catch (error) {
						console.log(error);
						showMessage(`Failed to switch address type: ${error.message}`);
					}
				});

				// Show custom backend input
				$('#wallet-backend-selected').on('change', function() {
					if ($('#wallet-backend-selected').val() !== 'custom') {
						hide('.custom-backend');
					} else {
						show('.custom-backend');
					}
				});

				$('#scan-modal').on('hide.bs.modal', function () {
					stopStream();
				});
			});
		</script>
	</body>
</html>
